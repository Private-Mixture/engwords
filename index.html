<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Words Gallery</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%2280%22 height=%2280%22 x=%2210%22 y=%2210%22 rx=%2215%22 ry=%2215%22 fill=%22%23bb86fc%22 /><text x=%2250%22 y=%2260%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22%23121212%22 font-family=%22sans-serif%22 font-weight=%22bold%22>W+</text></svg>">
    <style>
        :root{--background-color:#121212;--surface-color:#1e1e1e;--primary-color:#bb86fc;--text-on-background:rgba(255,255,255,.87);--text-on-surface:rgba(255,255,255,.6);--border-color:rgba(255,255,255,.12);--danger-color:#cf6679;--success-color:#03dac6}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background-color:var(--background-color);color:var(--text-on-background);margin:0;padding:16px;font-size:14px;overscroll-behavior-y:contain}
        .container{max-width:600px;margin:0 auto;background-color:var(--surface-color);border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.2);padding:16px;margin-bottom: 24px;}
        h1{font-size:24px;font-weight:600;margin:0 0 16px;text-align:center;color:var(--primary-color)}
        .form-section{margin-bottom:16px}
        .form-section label{display:block;margin-bottom:8px;font-weight:500;color:var(--text-on-surface)}
        .input-field, .edit-input{width:100%;padding:10px;border:1px solid var(--border-color);background-color:#2c2c2c;color:var(--text-on-background);border-radius:6px;box-sizing:border-box;font-size:14px}
        .input-field:focus, .edit-input:focus{outline:2px solid var(--primary-color);border-color:transparent}
        .button{width:100%;padding:12px;border:none;border-radius:6px;background-color:var(--primary-color);color:#000;font-size:16px;font-weight:600;cursor:pointer;text-align:center;transition:background-color .2s ease}
        .button:hover{background-color:#a050f0}
        .button:disabled{background-color:#555;color:#999;cursor:not-allowed}
        #gallery-container{max-width:600px; margin: 0 auto;}
        #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;margin-top:16px}
        .gallery-item{position:relative;border-radius:6px;overflow:hidden;background-color:#2c2c2c;box-shadow:0 2px 4px rgba(0,0,0,.3);display:flex;flex-direction:column}
        .gallery-item:hover{transform:translateY(-4px);box-shadow:0 6px 12px rgba(0,0,0,.4)}
        .gallery-item img{width:100%;height:120px;object-fit:cover;display:block}
        .gallery-item-footer{padding:8px;margin-top:auto}
        .gallery-item-footer p{margin:0;text-align:center;font-size:14px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .action-btn{position:absolute;top:6px;width:24px;height:24px;border:none;border-radius:50%;cursor:pointer;opacity:0;transform:scale(.8);transition:opacity .2s,transform .2s;display:flex;align-items:center;justify-content:center}
        .action-btn svg{width:14px;height:14px;fill:var(--background-color)}
        .delete-btn{right:6px;background-color:var(--danger-color)}
        .edit-btn{right:36px;background-color:var(--text-on-surface)}
        .gallery-item:hover .action-btn{opacity:1;transform:scale(1)}
        .or-separator{text-align:center;margin:16px 0;color:var(--text-on-surface);font-weight:500;font-size:12px}
        #storage-container{margin-top:16px}
        #storage-info{text-align:center;font-size:12px;color:var(--text-on-surface);margin-bottom:6px}
        #storage-bar-background{width:100%;height:8px;background-color:#2c2c2c;border-radius:4px;overflow:hidden;border:1px solid var(--border-color)}
        #storage-bar-fill{width:0%;height:100%;background-color:var(--primary-color);border-radius:4px;transition:width .3s ease-out}
        #error-message{color:var(--danger-color);font-weight:500;font-size:13px;text-align:center;padding:8px;background-color:rgba(207,102,121,.1);border-radius:4px;margin-bottom:12px;display:none}
        .edit-controls{display:flex;justify-content:space-between;margin-top:4px}
        .edit-controls button{background:0 0;border:0;cursor:pointer;padding:4px}
        .edit-controls svg{width:20px;height:20px}
        #sort-container{display:flex;justify-content:center;gap:20px;margin-bottom:16px;font-size:14px}
        #sort-container label{cursor:pointer;color:var(--text-on-surface)}
        #sort-container input:checked + label{color:var(--primary-color);font-weight:600}
        .edit-replace-section{margin-top:12px; padding-top:12px; border-top: 1px solid var(--border-color);}
        .edit-replace-section label{font-size:12px;}
    </style>
</head>
<body>

    <div class="container">
        <h1>Add New Word</h1>
        <div id="error-message"></div>
        <div class="form-section">
            <label for="word">1. Enter a caption (word)</label>
            <input type="text" id="word" class="input-field" placeholder="e.g., Innovation">
        </div>
        <div class="form-section">
            <label for="image-url">2a. Paste an image URL</label>
            <input type="text" id="image-url" class="input-field" placeholder="https://...">
        </div>
        <div class="or-separator">OR</div>
        <div class="form-section">
             <label for="image-file">2b. Upload a file from your computer</label>
             <input type="file" id="image-file" class="input-field" accept="image/jpeg, image/png, image/webp, image/gif">
        </div>
        <button id="add-btn" class="button">Add to Gallery</button>
        <div id="storage-container">
            <div id="storage-info"></div>
            <div id="storage-bar-background"><div id="storage-bar-fill"></div></div>
        </div>
    </div>

    <div id="gallery-container">
        <div id="sort-container">
            <input type="radio" name="sort" id="sort-alpha" checked style="display:none;">
            <label for="sort-alpha">Sort by Name (A-Z)</label>
            <input type="radio" name="sort" id="sort-date" style="display:none;">
            <label for="sort-date">Sort by Date (Newest)</label>
        </div>
        <div id="gallery"></div>
    </div>
    
    <svg style="display:none;"><symbol id="icon-pencil" viewBox="0 0 24 24">...</symbol><symbol id="icon-check" viewBox="0 0 24 24">...</symbol><symbol id="icon-cross" viewBox="0 0 24 24">...</symbol></svg>

    <script>
        const wordInput = document.getElementById('word'), imageUrlInput = document.getElementById('image-url'), imageFileInput = document.getElementById('image-file'), addBtn = document.getElementById('add-btn'), gallery = document.getElementById('gallery'), storageInfo = document.getElementById('storage-info'), storageBarFill = document.getElementById('storage-bar-fill'), errorMessage = document.getElementById('error-message'), sortAlpha = document.getElementById('sort-alpha'), sortDate = document.getElementById('sort-date');
        const STORAGE_LIMIT = 5 * 1024 * 1024, COMPRESSION_QUALITY = 0.75, MAX_DIMENSION = 300;
        let words = [], currentSort = 'alpha';

        function displayError(msg) { errorMessage.textContent = msg; errorMessage.style.display = 'block'; }
        function hideError() { errorMessage.style.display = 'none'; }
        
        function updateStorageInfo() {
            const usage = (localStorage.getItem('galleryWords') || '').length, usageKB = (usage / 1024).toFixed(2), limitMB = (STORAGE_LIMIT / 1024 / 1024).toFixed(2);
            storageInfo.textContent = `Storage: ${usageKB} KB / ~${limitMB} MB used`;
            storageBarFill.style.width = `${Math.min((usage / STORAGE_LIMIT) * 100, 100)}%`;
        }

        function saveWords() {
            try {
                const data = JSON.stringify(words);
                if (data.length > STORAGE_LIMIT) { displayError('Storage limit exceeded!'); loadWords(); return false; }
                localStorage.setItem('galleryWords', data);
                renderGallery(); return true;
            } catch (e) { displayError('Failed to save data.'); return false; }
        }

        function loadWords() {
            const saved = localStorage.getItem('galleryWords');
            if (saved) {
                try { 
                    words = JSON.parse(saved);
                    // Migration: Add timestamp to old items
                    let needsSave = false;
                    words.forEach(w => { if (!w.timestamp) { w.timestamp = Date.now(); needsSave = true; }});
                    if (needsSave) saveWords();
                } catch(e) { words = []; displayError("Could not load saved data."); }
            }
            renderGallery();
        }

        function renderGallery() {
            gallery.innerHTML = '';
            let sorted = [...words];
            if (currentSort === 'alpha') sorted.sort((a, b) => a.word.localeCompare(b.word));
            else sorted.sort((a, b) => b.timestamp - a.timestamp);

            sorted.forEach(item => {
                const idx = words.findIndex(w => w.timestamp === item.timestamp);
                const div = document.createElement('div');
                div.className = 'gallery-item';
                div.setAttribute('data-index', idx);
                div.innerHTML = `<img src="${item.image}" alt="${item.word}"><div class="gallery-item-footer"><p>${item.word}</p></div><button class="action-btn edit-btn" title="Edit"><svg ...></svg></button><button class="action-btn delete-btn" title="Delete"><svg ...></svg></button>`;
                gallery.appendChild(div);
            });
            updateStorageInfo();
        }
        
        function enterEditMode(itemDiv, index) {
            const item = words[index], footer = itemDiv.querySelector('.gallery-item-footer');
            footer.innerHTML = `
                <input type="text" class="edit-input" value="${item.word}">
                <div class="edit-replace-section">
                    <label>Replace Image (Optional)</label>
                    <input type="text" class="edit-image-url" placeholder="New image URL...">
                    <input type="file" class="edit-image-file" style="width:100%">
                </div>
                <div class="edit-controls"><button class="save-edit-btn" title="Save"><svg ...></svg></button><button class="cancel-edit-btn" title="Cancel"><svg ...></svg></button></div>`;
            const input = footer.querySelector('.edit-input');
            input.focus(); input.select();
        }

        gallery.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const itemDiv = btn.closest('.gallery-item'), index = parseInt(itemDiv.getAttribute('data-index'));
            if (isNaN(index)) return;

            if (btn.classList.contains('delete-btn')) {
                if (confirm(`Delete "${words[index].word}"?`)) { words.splice(index, 1); saveWords(); }
            } else if (btn.classList.contains('edit-btn')) {
                renderGallery(); // Reset other items
                enterEditMode(itemDiv, index);
            } else if (btn.classList.contains('cancel-edit-btn')) {
                renderGallery();
            } else if (btn.classList.contains('save-edit-btn')) {
                const newWord = itemDiv.querySelector('.edit-input').value.trim(), newUrl = itemDiv.querySelector('.edit-image-url').value.trim(), newFile = itemDiv.querySelector('.edit-image-file').files[0];
                const hasNewWord = newWord && newWord !== words[index].word, hasNewImage = newUrl || newFile;

                if (!hasNewWord && !hasNewImage) { renderGallery(); return; }
                if (hasNewWord) words[index].word = newWord;

                if (hasNewImage) {
                    const handleNewImage = (imgData) => { words[index].image = imgData; saveWords(); };
                    const handleError = (msg) => { displayError(msg); renderGallery(); };
                    if (newUrl) toDataURL(newUrl, handleNewImage, handleError);
                    else handleImageBlob(newFile, handleNewImage, handleError);
                } else if (hasNewWord) {
                    saveWords();
                }
            }
        });

        function compressImage(blob, cb, errCb) {
            const img = new Image(); img.src = URL.createObjectURL(blob);
            img.onload = () => {
                const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d'); let { width: w, height: h } = img;
                if (w > h) { if (w > MAX_DIMENSION) h *= MAX_DIMENSION / w, w = MAX_DIMENSION; } else if (h > MAX_DIMENSION) w *= MAX_DIMENSION / h, h = MAX_DIMENSION;
                canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h); cb(canvas.toDataURL('image/jpeg', COMPRESSION_QUALITY));
            };
            img.onerror = () => errCb("Could not process image file.");
        }
        function handleImageBlob(blob, cb, errCb) { compressImage(blob, cb, errCb); }
        function toDataURL(url, cb, errCb) {
            const proxy = 'https://api.allorigins.win/raw?url='; let finalUrl;
            try { finalUrl = proxy + encodeURIComponent(url); } catch(e) { return errCb("Invalid URL."); }
            const xhr = new XMLHttpRequest();
            xhr.onload = () => xhr.status >= 400 ? errCb(`Fetch error: ${xhr.status}`) : handleImageBlob(xhr.response, cb, errCb);
            xhr.onerror = () => errCb("Network error.");
            xhr.open('GET', finalUrl); xhr.responseType = 'blob'; xhr.send();
        }

        addBtn.addEventListener("click", () => {
            hideError(); addBtn.disabled = true; addBtn.textContent = 'Adding...';
            const word = wordInput.value.trim(), url = imageUrlInput.value.trim(), file = imageFileInput.files[0];
            const cleanup = () => { addBtn.disabled = false; addBtn.textContent = 'Add to Gallery'; };
            const handleError = msg => { displayError(msg); cleanup(); };
            
            if (!word) return handleError('Please enter a word.');
            if (!url && !file) return handleError('Please provide an image.');
            if (url && file) return handleError('Use either a URL or a file.');
            if (words.some(w => w.word.toLowerCase() === word.toLowerCase())) return handleError(`Word "${word}" already exists.`);
            
            const addItem = imgData => {
                words.push({ word, image: imgData, timestamp: Date.now() });
                if (saveWords()) { wordInput.value = ''; imageUrlInput.value = ''; imageFileInput.value = ''; }
                cleanup();
            };
            
            if (url) toDataURL(url, addItem, handleError);
            else if (file) handleImageBlob(file, addItem, handleError);
        });
        
        sortAlpha.addEventListener('change', () => { currentSort = 'alpha'; renderGallery(); });
        sortDate.addEventListener('change', () => { currentSort = 'date'; renderGallery(); });
        loadWords();
    </script>
</body>
</html>
